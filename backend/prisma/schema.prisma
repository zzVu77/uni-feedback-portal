// ================================
// Prisma Schema for Feedback System
// Refactored version - UUID, defaults, best practices
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// ENUMS (singular form)
// ================================

enum NotificationType {
  // User-facing notifications about forum posts (related to feedback)
  VOTE_FORUM_POST_NOTIFICATION
  COMMENT_FORUM_POST_NOTIFICATION
  REPLY_COMMENT_FORUM_POST_NOTIFICATION

  // User-facing notifications about announcements
  NEW_ANNOUNCEMENT_NOTIFICATION
  VOTE_ANNOUNCEMENT_NOTIFICATION
  COMMENT_ANNOUNCEMENT_NOTIFICATION
  REPLY_COMMENT_ANNOUNCEMENT_NOTIFICATION

  // User-facing notifications about reports
  REPORT_SUBMITTED_CONFIRMATION
  REPORT_RESOLVED_VIOLATION
  REPORT_RESOLVED_NO_VIOLATION
  YOUR_COMMENT_WAS_DELETED

  // User-facing notifications about clarifications/messages
  MESSAGE_NEW_NOTIFICATION
  CLARIFICATION_NEW_NOTIFICATION
  CLARIFICATION_CLOSED_NOTIFICATION

  // User-facing notifications about feedback lifecycle
  FEEDBACK_SUBMITTED_NOTIFICATION
  FEEDBACK_PROCESSING_NOTIFICATION
  FEEDBACK_RESOLVED_NOTIFICATION
  FEEDBACK_REJECTED_NOTIFICATION

  // Department staff notifications
  NEW_FEEDBACK_RECEIVED
  FEEDBACK_FORWARDED_TO_YOU

  // Admin notifications
  NEW_COMMENT_REPORT_FOR_ADMIN

  // General/System notifications
  ADMIN_NOTIFICATION
  SYSTEM_ANNOUNCEMENT_NOTIFICATION
}

enum FeedbackStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum ReportStatus {
  RESOLVED
  PENDING
}

enum UserRole {
  DEPARTMENT_STAFF
  STUDENT
  ADMIN
}

enum CommentTargetType {
  FORUM_POST
  ANNOUNCEMENT
}

// Thêm Enum mới cho các loại đính kèm file
enum FileTargetType {
  FEEDBACK
  MESSAGE
  ANNOUNCEMENT
}


// ================================
// MODELS
// ================================

model Users {
  id             String   @id @default(uuid()) @db.Uuid
  fullName       String
  password       String
  email          String   @unique
  role           UserRole
  departmentId   String?   @db.Uuid
  createdAt      DateTime @default(now())

  department     Departments?                   @relation(fields: [departmentId], references: [id])
  feedbacks      Feedbacks[]
  votes          Votes[]
  comments       Comments[]
  commentReports CommentReports[]
  forwardingLogs ForwardingLogs[]
  conversations  ClarificationConversations[]
  messages       Messages[]
  announcements  Announcements[]
  notifications  Notifications[]
  refreshTokens  RefreshTokens[]
  deletedComments Comments[] @relation("CommentDeleter")
}

model Departments {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  email        String   @unique
  description  String?
  location     String?
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  users                          Users[]
  feedbacks                      Feedbacks[]
  forwardingLogsFromDepartmentId ForwardingLogs[] @relation("FromDepartment")
  forwardingLogsToDepartmentId   ForwardingLogs[] @relation("ToDepartment")

  @@index([isActive])
}

model Categories {
  id        String      @id @default(uuid()) @db.Uuid
  name      String      @unique
  isActive  Boolean     @default(true) 
  feedbacks Feedbacks[]

  @@index([isActive]) 
}

model Feedbacks {
  id              String            @id @default(uuid()) @db.Uuid
  subject         String
  description     String
  location        String?
  currentStatus   FeedbackStatus    @default(PENDING)
  isPrivate       Boolean           @default(false)
  userId          String            @db.Uuid
  departmentId    String            @db.Uuid
  categoryId      String            @db.Uuid
  createdAt       DateTime          @default(now())

  user            Users             @relation(fields: [userId], references: [id])
  department      Departments       @relation(fields: [departmentId], references: [id])
  category        Categories        @relation(fields: [categoryId], references: [id])
  statusHistory   FeedbackStatusHistory[]
  forwardingLogs  ForwardingLogs[]
  forumPost       ForumPosts?
  conversations   ClarificationConversations[]
}

model FeedbackStatusHistory {
  id          String          @id @default(uuid()) @db.Uuid
  feedbackId  String          @db.Uuid
  status      FeedbackStatus
  message     String           // luôn required
  note        String?          // cho phép null
  createdAt   DateTime         @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
}

model ForwardingLogs {
  id               String   @id @default(uuid()) @db.Uuid
  feedbackId       String   @db.Uuid
  fromDepartmentId String   @db.Uuid
  toDepartmentId   String   @db.Uuid
  userId           String   @db.Uuid
  message          String
  note             String?
  createdAt        DateTime @default(now())

  feedback        Feedbacks   @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  fromDepartment  Departments @relation("FromDepartment", fields: [fromDepartmentId], references: [id])
  toDepartment    Departments @relation("ToDepartment", fields: [toDepartmentId], references: [id])
  user            Users       @relation(fields: [userId], references: [id])
}

model ForumPosts {
  id         String   @id @default(uuid()) @db.Uuid
  feedbackId String   @unique @db.Uuid
  createdAt  DateTime @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  votes    Votes[]
}

model Votes {
  userId    String   @db.Uuid
  postId    String   @db.Uuid
  createdAt DateTime @default(now())

  user Users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post ForumPosts @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
}

model Comments {
  id           String             @id @default(uuid()) @db.Uuid
  targetId     String             @db.Uuid              
  targetType   CommentTargetType  
  userId       String             @db.Uuid
  parentId     String?            @db.Uuid
  content      String
  createdAt    DateTime           @default(now())
  deletedAt    DateTime?          
  deletedBy  String?   @db.Uuid
  user         Users              @relation(fields: [userId], references: [id])
  reports      CommentReports[]
  parent       Comments?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comments[]         @relation("CommentReplies")
  deleter    Users?    @relation("CommentDeleter", fields: [deletedBy], references: [id])
}


model CommentReports {
  id             String        @id @default(uuid()) @db.Uuid
  commentId      String        @db.Uuid
  userId         String        @db.Uuid
  reason         String?
  status         ReportStatus  @default(PENDING)
  adminResponse  String?
  createdAt      DateTime      @default(now())

  comment Comments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    Users    @relation(fields: [userId], references: [id])
}

model ClarificationConversations {
  id          String   @id @default(uuid()) @db.Uuid
  subject     String
  feedbackId  String   @db.Uuid
  isClosed    Boolean  @default(false)
  userId      String   @db.Uuid
  createdAt   DateTime @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user     Users     @relation(fields: [userId], references: [id])
  messages Messages[]
}

model Messages {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  userId         String   @db.Uuid
  content        String?  
  createdAt      DateTime @default(now())

  conversation ClarificationConversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         Users                     @relation(fields: [userId], references: [id])
}

model FileAttachments {
  id         String         @id @default(uuid()) @db.Uuid
  targetId   String         @db.Uuid
  targetType FileTargetType

  fileName String
  fileUrl  String
  fileType String
  fileSize Int

  createdAt DateTime @default(now())

  @@index([targetId, targetType])
}


model Announcements {
  id         String   @id @default(uuid()) @db.Uuid
  title      String
  content    String
  createdAt  DateTime @default(now())
  userId     String   @db.Uuid

  user  Users           @relation(fields: [userId], references: [id])
}
model Notifications {
  id                String            @id @default(uuid()) @db.Uuid
  userId            String            @db.Uuid
  content           String
  title            String @default("Thông báo mới")
  notificationType  NotificationType
  targetId          String?           @db.Uuid // ID of the related entity (e.g., feedback, comment, announcement)
  isRead            Boolean           @default(false)
  createdAt         DateTime          @default(now())

  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshTokens {
  token     String   @id @unique
  userId    String   @db.Uuid 
  expiredAt DateTime
  createdAt DateTime @default(now())
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}