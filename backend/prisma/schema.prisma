// ================================
// Prisma Schema for Feedback System
// Refactored version - UUID, defaults, best practices
// ================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ================================
// ENUMS (singular form)
// ================================

enum NotificationType {
  VOTE_NOTIFICATION
  REPORT_NOTIFICATION
  COMMENT_NOTIFICATION
  MESSAGE_NOTIFICATION
  FEEDBACK_NOTIFICATION
  ANNOUNCEMENT_NOTIFICATION
}

enum FeedbackStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  REJECTED
}

enum ReportStatus {
  RESOLVED
  PENDING
  REJECTED
}

enum UserRole {
  DEPARTMENT_STAFF
  STUDENT
  ADMIN
}

enum CommentTargetType {
  FORUM_POST
  ANNOUNCEMENT
}


// ================================
// MODELS
// ================================

model Users {
  id             String   @id @default(uuid()) @db.Uuid
  fullName       String
  password       String
  email          String   @unique
  role           UserRole
  departmentId   String   @db.Uuid
  createdAt      DateTime @default(now())

  department     Departments                   @relation(fields: [departmentId], references: [id])
  feedbacks      Feedbacks[]
  votes          Votes[]
  comments       Comments[]
  commentReports CommentReports[]
  forwardingLogs ForwardingLogs[]
  conversations  ClarificationConversations[]
  messages       Messages[]
  announcements  Announcements[]
  notifications  Notifications[]
  refreshTokens  RefreshTokens[]
}

model Departments {
  id           String  @id @default(uuid()) @db.Uuid
  name         String

  users        Users[]
  feedbacks    Feedbacks[]
  forwardingLogsFromDepartmentId ForwardingLogs[] @relation("FromDepartment")
  forwardingLogsToDepartmentId   ForwardingLogs[] @relation("ToDepartment")
}

model Categories {
  id   String  @id @default(uuid()) @db.Uuid
  name String

  feedbacks Feedbacks[]
}

model Feedbacks {
  id              String            @id @default(uuid()) @db.Uuid
  subject         String
  description     String
  location       String? 
  currentStatus   FeedbackStatus    @default(PENDING)
  isPrivate       Boolean           @default(false)
  userId          String            @db.Uuid
  departmentId    String            @db.Uuid
  categoryId      String            @db.Uuid
  createdAt       DateTime          @default(now())

  user            Users             @relation(fields: [userId], references: [id])
  department      Departments       @relation(fields: [departmentId], references: [id])
  category        Categories        @relation(fields: [categoryId], references: [id])
  statusHistory   FeedbackStatusHistory[]
  forwardingLogs  ForwardingLogs[]
  forumPost       ForumPosts?
  conversations   ClarificationConversations[]
  fileAttachments FileAttachmentForFeedback[]
}

model FeedbackStatusHistory {
  id          String          @id @default(uuid()) @db.Uuid
  feedbackId  String          @db.Uuid
  status      FeedbackStatus
  message     String           // luôn required
  note        String?          // cho phép null
  createdAt   DateTime         @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
}

model ForwardingLogs {
  id               String   @id @default(uuid()) @db.Uuid
  feedbackId       String   @db.Uuid
  fromDepartmentId String   @db.Uuid
  toDepartmentId   String   @db.Uuid
  userId           String   @db.Uuid
  message          String
  note             String?
  createdAt        DateTime @default(now())

  feedback        Feedbacks   @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  fromDepartment  Departments @relation("FromDepartment", fields: [fromDepartmentId], references: [id])
  toDepartment    Departments @relation("ToDepartment", fields: [toDepartmentId], references: [id])
  user            Users       @relation(fields: [userId], references: [id])
}

model ForumPosts {
  id         String   @id @default(uuid()) @db.Uuid
  feedbackId String   @unique @db.Uuid
  createdAt  DateTime @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  votes    Votes[]
}

model Votes {
  userId    String   @db.Uuid
  postId    String   @db.Uuid
  createdAt DateTime @default(now())

  user Users      @relation(fields: [userId], references: [id], onDelete: Cascade)
  post ForumPosts @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
}

model Comments {
  id           String             @id @default(uuid()) @db.Uuid
  targetId     String             @db.Uuid              
  targetType   CommentTargetType  
  userId       String             @db.Uuid
  parentId     String?            @db.Uuid
  content      String
  createdAt    DateTime           @default(now())
  deletedAt    DateTime?          
  user         Users              @relation(fields: [userId], references: [id])
  reports      CommentReports[]
  parent       Comments?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies      Comments[]         @relation("CommentReplies")
}


model CommentReports {
  id             String        @id @default(uuid()) @db.Uuid
  commentId      String        @db.Uuid
  userId         String        @db.Uuid
  reason         String?
  status         ReportStatus  @default(PENDING)
  adminResponse  String?
  createdAt      DateTime      @default(now())

  comment Comments @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    Users    @relation(fields: [userId], references: [id])
}

model ClarificationConversations {
  id          String   @id @default(uuid()) @db.Uuid
  feedbackId  String   @db.Uuid
  isClosed    Boolean  @default(false)
  userId      String   @db.Uuid
  createdAt   DateTime @default(now())

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  user     Users     @relation(fields: [userId], references: [id])
  messages Messages[]
}

model Messages {
  id             String   @id @default(uuid()) @db.Uuid
  conversationId String   @db.Uuid
  userId         String   @db.Uuid
  content        String?  
  createdAt      DateTime @default(now())

  conversation ClarificationConversations @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         Users                     @relation(fields: [userId], references: [id])
  attachments  FileAttachmentForMessage[] 
}

model FileAttachmentForMessage {
  id        String   @id @default(uuid()) @db.Uuid
  messageId String   @db.Uuid
  fileName  String
  fileUrl   String

  message Messages @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model FileAttachmentForFeedback {
  id         String  @id @default(uuid()) @db.Uuid
  feedbackId String  @db.Uuid
  fileName   String
  fileUrl    String

  feedback Feedbacks @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
}

model FileAttachmentForAnnouncement {
  id             String  @id @default(uuid()) @db.Uuid
  announcementId String  @db.Uuid
  fileName       String
  fileUrl        String

  announcement Announcements @relation(fields: [announcementId], references: [id], onDelete: Cascade)
}

model Announcements {
  id         String   @id @default(uuid()) @db.Uuid
  title      String
  content    String
  createdAt  DateTime @default(now())
  userId     String   @db.Uuid

  user  Users                        @relation(fields: [userId], references: [id])
  files FileAttachmentForAnnouncement[]
}

model Notifications {
  id                String            @id @default(uuid()) @db.Uuid
  userId            String            @db.Uuid
  content           String
  notificationType  NotificationType
  isRead            Boolean           @default(false)
  createdAt         DateTime          @default(now())
  relatedEntityId   String?          @db.Uuid 
  user Users @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model RefreshTokens {
  token     String   @id @unique
  userId    String   @db.Uuid 
  expiredAt DateTime
  createdAt DateTime @default(now())
  user      Users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}