name: Auto Close Issues (Strict Regex)

on:
  pull_request:
    types: [closed]
    branches: [main, dev]

jobs:
  close-issues-strict:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    steps:
      - name: Scan Commits and Close Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_ID: ${{ github.event.pull_request.number }}
        run: |
          # LOGIC AN TOÀN:
          # Bước 1 (grep -iEo): Chỉ lấy các chuỗi khớp mẫu: "issuse #123" hoặc "fix #123".
          #                     Nó sẽ BỎ QUA các chuỗi chỉ có số như "(#111)" vì thiếu từ khóa phía trước.
          # Bước 2 (grep -oE):  Từ kết quả "issuse #123", cắt lấy "#123".

          gh pr view $PR_ID --json commits --jq '.commits[].messageHeadline + " " + .commits[].messageBody' \
          | grep -iEo "(issuse|issue|fix|close|resolve)[a-z]*\s+#\d+" \
          | grep -oE "#\d+" \
          | sort -u \
          | xargs -I {} gh issue close {} --comment "Closed automatically via merge commit scan." || true
