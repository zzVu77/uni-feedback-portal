name: Auto Close Issues (Strict Regex)

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  close-issues-strict:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
      contents: read # Cần quyền đọc để checkout code
    steps:
      # --- BƯỚC QUAN TRỌNG VỪA THÊM VÀO ---
      - name: Checkout code
        uses: actions/checkout@v4
      # ------------------------------------

      - name: Scan Commits and Close Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_ID: ${{ github.event.pull_request.number }}
        run: |
          # Checkout xong thì folder hiện tại mới là git repo, lệnh gh mới hiểu context

          gh pr view $PR_ID --json commits --jq '.commits[].messageHeadline + " " + .commits[].messageBody' \
          | grep -iEo "(issuse|issue|fix|close|resolve)[a-z]*\s+#\d+" \
          | grep -oE "#\d+" \
          | sort -u \
          | xargs -I {} gh issue close {} --comment "Closed automatically via merge commit scan." || true
